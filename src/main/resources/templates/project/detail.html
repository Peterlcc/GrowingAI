<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>项目详情</title>

  <!-- Bootstrap core CSS -->
  <link th:href="@{/webjars/bootstrap/4.3.1/css/bootstrap.css}" href="asserts/css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom styles for this template -->
  <link th:href="@{/css/modern-business.css}" href="css/modern-business.css" rel="stylesheet">
  <link th:href="@{/css/codemirror/codemirror.css}" rel="stylesheet">
  <link th:href="@{/css/codemirror/simplescrollbars.css}" rel="stylesheet">
  <link th:href="@{/css/codemirror/idea.css}" rel="stylesheet">
<!--  <link th:href="@{/css/font-awesome.min.css}" href="css/modern-business.css" rel="stylesheet">-->
  <link href="http://netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    *{
      font-family: 微软雅黑;
    }
    .a{
      /*width: 80%;
      border: 2px dashed #666;*/
      margin: 0 auto;
    }
    h2{
      width: 80%;
      margin: 0 auto;
      padding: 20px;
    }
    pre{
      width: 80%;
      margin: 0 auto;
      border: 1px solid #ddd;
      color: #000;
      padding: 10px;
      border-radius: 10px;
      font-size: 15px;
    }
  </style>
</head>

<body>

  <div th:replace="commons/base::topbar"></div>

  <!-- Page Content -->
  <div class="container">

    <!-- Page Heading/Breadcrumbs -->
    <h1 class="mt-4 mb-3">可成长系统之
      <small>项目详情</small>
    </h1>

    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <a th:href="@{/index}" href="index.html">首页</a>
      </li>
      <li class="breadcrumb-item active">项目详情</li>
    </ol>

    <!-- Portfolio Item Row -->
    <div class="row">


      <div class="col-md-5">
        <p class="text-hide" id="pid" th:text="${project.id}" th:attr="url=@{/project/struct},fileUrl=@{/project/file}"></p>
        <h3 class="my-3" th:text="'项目名称：'+${project.name}">Project Description</h3>
        <p th:text="'项目描述：'+${project.description}">que urna variustricies, jus</p>
        <p th:text="'项目类型：'+${project.type.name}">Lorem ipsum dolor sit amet, consectetur adipiscing elit</p>
        <p style="color: #ff7332" th:if="${project.results==null}" th:text="暂无测试结果">Lorem ipsum dolor sit amet, consectetur adipiscing elit</p>
        <div th:if="${project.results!=null}" th:each="result,resultStat:${project.results}">

          <p th:text="'测试结果'+${resultStat.count}+'：[length:'+${result.getLength()}+',points:'+${result.getPoints()}+',time:'+${result.getTime()+'s]'}"></p>
        </div>
        <h3 class="my-3">项目文件</h3>
        <div class="a" id="struct"></div>
      </div>
      <div class="col-md-7">
        <div>
          <label for="mode" style="font-size: 30px">选择语言：</label>
          <select id="mode" class="form-control col-6 pull-right" onchange="switchMode();">
            <option value="text/x-cmake" selected="selected">Cmake</option>
            <option value="text/html">XML</option>
            <option value="python">Python</option>
            <option value="text/x-c++src">C++</option>
          </select>
        </div>
        <textarea rows="10" readonly="readonly" id="fileDetail" filePath="null">

        </textarea>
        <div class="btn-group" role="group">
          <button th:if="${own}" id="saveFile" onclick="saveFile();" class="btn btn-primary" disabled>保存</button>
        </div>

      </div>

    </div>
    <!-- /.row -->

  </div>
  <!-- /.container -->


  <!-- Bootstrap core JavaScript -->
  <script type="text/javascript" th:src="@{/webjars/jquery/3.4.1/jquery.min.js}"></script>
  <script th:src="@{/webjars/bootstrap/4.3.1/js/bootstrap.bundle.js}"></script>
  <script th:src="@{/js/LuTree.js}"></script>
  <script th:src="@{/js/codemirror/codemirror.js}"></script>
  <script th:src="@{/js/codemirror/simplescrollbars.js}"></script>
  <script th:src="@{/js/codemirror/python.js}"></script>
  <script th:src="@{/js/codemirror/cmake.js}"></script>
  <script th:src="@{/js/codemirror/clike.js}"></script>
  <script th:src="@{/js/codemirror/xml.js}"></script>
  <script type="text/javascript">
    var editor = CodeMirror.fromTextArea(document.getElementById("fileDetail"), {
      mode:"text/x-cmake",
      lineNumbers: true,
      readOnly: false,        //只读模式
      smartIndent: true , //智能缩进
      indentUnit: 4, // 智能缩进单位为4个空格长度
      indentWithTabs:true,  // 使用制表符进行智能缩进
      lineWrapping:true,//
      // 在行槽中添加行号显示器、折叠器、语法检测器`
      gutters: ["CodeMirror-linenumbers","CodeMirror-foldgutter","CodeMirror-lint-markers"],
      foldGutter:true, // 启用行槽中的代码折叠
      autofocus:true, //自动聚焦
      matchBrackets:true,// 匹配结束符号，比如"]、}"
      autoCloseBrackets: true , // 自动闭合符号
        scrollbarStyle:"simple",
      styleActiveLine:true // 显示选中行的样式
    });
    editor.on("change",function () {
      var curPath=$("#fileDetail").attr("filePath");
      if (curPath=='null'){
        return;
      }
      console.log("代码改变了");
      $("#saveFile").removeAttr("disabled");
    });
    // 在最后一行中追加codemirror编辑器内容
    function updateCodeMirror(data){
      var doc = editor.getDoc();
      var cursor = doc.getCursor(); // gets the line number in the cursor position
      var line = doc.getLine(cursor.line); // get the line contents
      var pos = { // create a new object to avoid mutation of the original selection
        line: editor.lastLine(), //获取最后一行，也可以获取当前光标行：cursor.line
        ch: line.length - 1 // set the character position to the end of the line
      };
      doc.setValue('');
      doc.replaceRange(data, pos); // adds a new line
      // 跳转到编辑器底部
      editor.execCommand("goDocStart");
    }
    // 跳转到编辑器顶部
    // editor.execCommand("goDocStart");


    function isNumber(val){

      var regPos = /^\d+(\.\d+)?$/; //非负浮点数
      var regNeg = /^(-(([0-9]+\.[0-9]*[1-9][0-9]*)|([0-9]*[1-9][0-9]*\.[0-9]+)|([0-9]*[1-9][0-9]*)))$/; //负浮点数
      if(regPos.test(val) || regNeg.test(val)){
        return true;
      }else{
        return false;
      }
    }
    
    function switchMode() {
      var mode = $("#mode").val();
      var doc = editor.getDoc();
      console.log("set mode to "+mode);
      doc.cm.setOption("mode",mode);
    }

    function saveFile() {
      var doc = editor.getDoc();
      var text=doc.getValue();
      var curPath=$("#fileDetail").attr("filePath");
      if (curPath=='null'){
        return;
      }
      $.ajax({
        url: $("#pid").attr("fileUrl"),
        data: {"text": doc.getValue(),"path":curPath},
        type: "POST",
        success: function (result) {
          if (result=="succeed"){
            $("#saveFile").attr("disabled","disabled");
          }else {
            alert("保存文件失败，请稍后重试！");
          }
        }
      });
    }

    //预加载数据格式
    console.log($("#pid").attr("url"));
    console.log($("#pid").text());
    $.ajax({
      url: $("#pid").attr("url"),
      data: {"id":$("#pid").text()},
      type:"GET",
      success:function (result) {
        console.log(result);
        //无限级菜单生成
        $("#struct").LuTree({
          arr: result,
          sign:true,
          simIcon: "fa fa-file-o",//叶子图标
          mouIconOpen: " fa fa-folder-open",//展开图标
          mouIconClose:"fa fa-folder",//关闭图标
          callback: function(path) {
            if(!isNumber(path)){
              $.ajax({
                url: $("#pid").attr("fileUrl"),
                data: {"path":path},
                type:"GET",
                success:function (result) {
                    // $("#fileDetail").text(result);
                  updateCodeMirror(result);
                  $("#fileDetail").attr("filePath",path);
                }
              });
            }
            console.log("你选择的path是" + path);
          }
        });
      }
    });

    </script>
</body>

</html>
